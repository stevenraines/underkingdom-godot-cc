extends GutTest
## Unit tests for Fatigue Recovery System
##
## Tests fatigue reduction through resting and consumable items,
## and verifies max stamina recovery when fatigue decreases.

const SurvivalSystemClass = preload("res://systems/survival_system.gd")
const ItemClass = preload("res://items/item.gd")


# =============================================================================
# Test: Fatigue Accumulation (baseline behavior)
# =============================================================================

func test_fatigue_accumulates_over_time() -> void:
	# Given: A survival system with 0 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.fatigue = 0.0
	survival.base_max_stamina = 150.0  # Manually set since we don't have an owner

	# When: Processing 100 turns (FATIGUE_GAIN_RATE)
	for turn in range(100):
		survival.process_turn(turn)

	# Then: Fatigue should have increased by 1
	assert_eq(survival.fatigue, 1.0, "Fatigue should increase by 1 after 100 turns")


func test_fatigue_reduces_max_stamina() -> void:
	# Given: A survival system with 50 fatigue and 150 base max stamina
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 50.0

	# When: Calculating max stamina
	var max_stamina = survival.get_max_stamina()

	# Then: Max stamina should be reduced by 50%
	# Base: 50 + (10 * 10) = 150
	# Reduced: 150 * (1 - 0.50) = 75
	assert_eq(max_stamina, 75.0, "Max stamina should be 75 with 50 fatigue")


func test_fatigue_100_reduces_to_minimum() -> void:
	# Given: A survival system with 100 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 100.0

	# When: Calculating max stamina
	var max_stamina = survival.get_max_stamina()

	# Then: Max stamina should be at minimum (10)
	assert_eq(max_stamina, 10.0, "Max stamina should be 10 (minimum) with 100 fatigue")


# =============================================================================
# Test: Fatigue Recovery via rest() method
# =============================================================================

func test_rest_reduces_fatigue() -> void:
	# Given: A survival system with 50 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity()
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 50.0

	# When: Calling rest(25)
	survival.rest(25.0)

	# Then: Fatigue should be reduced to 25
	assert_eq(survival.fatigue, 25.0, "Fatigue should be reduced to 25 after resting 25")


func test_rest_cannot_go_below_zero() -> void:
	# Given: A survival system with 10 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity()
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 10.0

	# When: Calling rest(50) (more than current fatigue)
	survival.rest(50.0)

	# Then: Fatigue should be clamped at 0
	assert_eq(survival.fatigue, 0.0, "Fatigue should not go below 0")


func test_rest_fully_restores_max_stamina() -> void:
	# Given: A survival system with 60 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 60.0
	var initial_max = survival.get_max_stamina()  # Should be 60

	# When: Resting to remove all fatigue
	survival.rest(60.0)
	var final_max = survival.get_max_stamina()

	# Then: Max stamina should be fully restored to base
	# Base: 50 + (10 * 10) = 150
	assert_eq(survival.fatigue, 0.0, "Fatigue should be 0")
	assert_eq(final_max, 150.0, "Max stamina should be fully restored to 150")
	assert_true(final_max > initial_max, "Max stamina should increase after rest")


# =============================================================================
# Test: Fatigue Recovery via Consumable Items
# =============================================================================

func test_restorative_tonic_item_exists() -> void:
	# When: Loading item definitions
	var item_data = _load_item_definition("restorative_tonic")

	# Then: Item should exist and have fatigue effect
	assert_not_null(item_data, "Restorative Tonic item definition should exist")
	assert_true(item_data.has("effects"), "Restorative Tonic should have effects")
	assert_true(item_data.effects.has("fatigue"), "Restorative Tonic should have fatigue effect")
	assert_eq(item_data.effects.fatigue, 25, "Restorative Tonic should reduce 25 fatigue")


func test_energizing_tea_item_exists() -> void:
	# When: Loading item definitions
	var item_data = _load_item_definition("energizing_tea")

	# Then: Item should exist and have fatigue effect
	assert_not_null(item_data, "Energizing Tea item definition should exist")
	assert_true(item_data.has("effects"), "Energizing Tea should have effects")
	assert_true(item_data.effects.has("fatigue"), "Energizing Tea should have fatigue effect")
	assert_eq(item_data.effects.fatigue, 15, "Energizing Tea should reduce 15 fatigue")


func test_restorative_tonic_reduces_fatigue() -> void:
	# Given: A mock player with 50 fatigue
	var mock_player = _create_mock_player()
	mock_player.survival.fatigue = 50.0

	# When: Applying restorative tonic effects
	var effects = {"fatigue": 25, "stamina": 20}
	mock_player.apply_item_effects(effects)

	# Then: Fatigue should be reduced by 25
	assert_eq(mock_player.survival.fatigue, 25.0, "Fatigue should be 25 after tonic")


func test_energizing_tea_reduces_fatigue() -> void:
	# Given: A mock player with 40 fatigue
	var mock_player = _create_mock_player()
	mock_player.survival.fatigue = 40.0

	# When: Applying energizing tea effects
	var effects = {"fatigue": 15, "thirst": 10}
	mock_player.apply_item_effects(effects)

	# Then: Fatigue should be reduced by 15
	assert_eq(mock_player.survival.fatigue, 25.0, "Fatigue should be 25 after tea")


# =============================================================================
# Test: Max Stamina Recovery When Fatigue Decreases
# =============================================================================

func test_max_stamina_increases_with_fatigue_decrease() -> void:
	# Given: A survival system with 150 base max stamina and 50 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 50.0

	var initial_max = survival.get_max_stamina()  # 75

	# When: Reducing fatigue by 25
	survival.rest(25.0)
	var new_max = survival.get_max_stamina()

	# Then: Max stamina should increase from 75 to 112.5
	# Old: 150 * (1 - 0.50) = 75
	# New: 150 * (1 - 0.25) = 112.5
	assert_eq(survival.fatigue, 25.0, "Fatigue should be 25")
	assert_eq(new_max, 112.5, "Max stamina should be 112.5")
	assert_almost_eq(new_max - initial_max, 37.5, 0.1, "Max stamina should increase by 37.5")


func test_partial_fatigue_recovery_increases_max_stamina() -> void:
	# Given: A survival system with 80 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 80.0

	# When: Reducing fatigue by 15 (energizing tea)
	survival.rest(15.0)
	var new_max = survival.get_max_stamina()

	# Then: Max stamina should increase
	# Base: 150
	# New fatigue: 65
	# New max: 150 * (1 - 0.65) = 52.5
	assert_eq(survival.fatigue, 65.0, "Fatigue should be 65")
	assert_eq(new_max, 52.5, "Max stamina should be 52.5")


func test_stamina_clamped_when_max_decreases() -> void:
	# Given: A survival system with current stamina at max
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity({"CON": 10})
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 0.0
	survival.stamina = survival.get_max_stamina()  # 150

	# When: Fatigue increases (simulating time passing)
	survival.fatigue = 50.0

	# Process turn to trigger clamping (as done in actual code)
	var new_max = survival.get_max_stamina()  # 75
	if survival.stamina > new_max:
		survival.stamina = new_max

	# Then: Current stamina should be clamped to new max
	assert_eq(survival.stamina, 75.0, "Stamina should be clamped to new max of 75")


# =============================================================================
# Test: Resting Rate (1 fatigue per 10 rest turns)
# =============================================================================

func test_rest_rate_calculation() -> void:
	# Given: The implemented rest rate of 1 fatigue per 10 turns
	var rest_turns = 100
	var expected_fatigue_reduction = rest_turns / 10  # 10 fatigue

	# When: Calculating expected reduction
	var actual_reduction = 10.0

	# Then: Should match the formula
	assert_eq(actual_reduction, expected_fatigue_reduction, "Rest rate should be 1 fatigue per 10 turns")


func test_full_recovery_time() -> void:
	# Given: A player with 100 fatigue
	var initial_fatigue = 100.0
	var rest_rate = 1.0 / 10.0  # 1 fatigue per 10 turns

	# When: Calculating turns needed for full recovery
	var turns_needed = initial_fatigue / rest_rate

	# Then: Should take 1000 turns to fully recover
	assert_eq(turns_needed, 1000.0, "Should take 1000 rest turns to recover 100 fatigue")


# =============================================================================
# Test: Balance - Accumulation vs Recovery
# =============================================================================

func test_recovery_rate_faster_than_accumulation() -> void:
	# Given: Accumulation rate (1 per 100 active turns) vs Recovery rate (1 per 10 rest turns)
	var accumulation_rate = 1.0 / 100.0  # per active turn
	var recovery_rate = 1.0 / 10.0  # per rest turn

	# Then: Recovery should be 10x faster than accumulation
	var ratio = recovery_rate / accumulation_rate
	assert_eq(ratio, 10.0, "Recovery should be 10x faster than accumulation")


# =============================================================================
# Test: Edge Cases
# =============================================================================

func test_zero_fatigue_stays_zero() -> void:
	# Given: A survival system with 0 fatigue
	var survival = SurvivalSystemClass.new(null)
	survival.base_max_stamina = 50.0 + _create_mock_entity()
	var survival = SurvivalSystemClass.new(mock_entity)
	survival.fatigue = 0.0

	# When: Resting with 0 fatigue
	survival.rest(10.0)

	# Then: Fatigue should remain 0
	assert_eq(survival.fatigue, 0.0, "Fatigue should stay at 0")


func test_multiple_consumables_stack() -> void:
	# Given: A mock player with 60 fatigue
	var mock_player = _create_mock_player()
	mock_player.survival.fatigue = 60.0

	# When: Consuming two energizing teas (15 each)
	mock_player.apply_item_effects({"fatigue": 15})
	mock_player.apply_item_effects({"fatigue": 15})

	# Then: Fatigue should be reduced by 30 total
	assert_eq(mock_player.survival.fatigue, 30.0, "Multiple consumables should stack")


# =============================================================================
# Test: Recipe Validation
# =============================================================================

func test_restorative_tonic_recipe_exists() -> void:
	# When: Loading recipe definitions
	var recipe_data = _load_recipe_definition("restorative_tonic")

	# Then: Recipe should exist and be valid
	assert_not_null(recipe_data, "Restorative Tonic recipe should exist")
	assert_eq(recipe_data.result, "restorative_tonic", "Recipe should create restorative_tonic")
	assert_true(recipe_data.fire_required, "Recipe should require fire")


func test_energizing_tea_recipe_exists() -> void:
	# When: Loading recipe definitions
	var recipe_data = _load_recipe_definition("energizing_tea")

	# Then: Recipe should exist and be valid
	assert_not_null(recipe_data, "Energizing Tea recipe should exist")
	assert_eq(recipe_data.result, "energizing_tea", "Recipe should create energizing_tea")
	assert_true(recipe_data.fire_required, "Recipe should require fire")


# =============================================================================
# Helper Functions
# =============================================================================

func _create_mock_entity(attrs: Dictionary = {}):
	var mock = MockEntity.new()
	mock.attributes = {
		"STR": attrs.get("STR", 10),
		"DEX": attrs.get("DEX", 10),
		"CON": attrs.get("CON", 10),
		"INT": attrs.get("INT", 10),
		"WIS": attrs.get("WIS", 10),
		"CHA": attrs.get("CHA", 10)
	}
	return mock


func _create_mock_player():
	var mock = MockPlayer.new()
	mock.attributes = {
		"STR": 10, "DEX": 10, "CON": 10,
		"INT": 10, "WIS": 10, "CHA": 10
	}
	mock.survival = SurvivalSystemClass.new(mock)
	return mock


func _load_item_definition(item_id: String) -> Dictionary:
	var file_path = "res://data/items/consumables/%s.json" % item_id
	if not FileAccess.file_exists(file_path):
		return {}

	var file = FileAccess.open(file_path, FileAccess.READ)
	if not file:
		return {}

	var json_string = file.get_as_text()
	file.close()

	var json = JSON.new()
	var error = json.parse(json_string)
	if error != OK:
		return {}

	return json.data


func _load_recipe_definition(recipe_id: String) -> Dictionary:
	var file_path = "res://data/recipes/consumables/%s.json" % recipe_id
	if not FileAccess.file_exists(file_path):
		return {}

	var file = FileAccess.open(file_path, FileAccess.READ)
	if not file:
		return {}

	var json_string = file.get_as_text()
	file.close()

	var json = JSON.new()
	var error = json.parse(json_string)
	if error != OK:
		return {}

	return json.data


# =============================================================================
# Mock Classes
# =============================================================================

class MockEntity:
	var attributes: Dictionary = {}
	var entity_id: String = "test_entity"
	var entity_type: String = "test"
	var name: String = "Test Entity"


class MockPlayer:
	var attributes: Dictionary = {}
	var entity_id: String = "test_player"
	var entity_type: String = "player"
	var name: String = "Test Player"
	var survival = null

	func apply_item_effects(effects: Dictionary) -> void:
		if "fatigue" in effects and survival:
			survival.rest(effects.fatigue)
		if "stamina" in effects and survival:
			survival.stamina = min(survival.get_max_stamina(), survival.stamina + effects.stamina)
		if "thirst" in effects and survival:
			survival.drink(effects.thirst)
